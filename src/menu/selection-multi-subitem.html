<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/paper-checkbox/paper-checkbox-custom.html">

<dom-module id="selection-multi-subitem">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-checkbox-custom {
                align-items: center;
                display: flex;
                padding: 10px 25px 10px 5px;
                flex-direction: row;
            }

            .subitemName {
                font-size: 15px;
                flex-grow: 99;
                padding: 0px 0px 0px 10px;
            }

            .subitemPrice {
                font-size: 15px;
            }

            .disabled {
                opacity: 0.5;
            }
        </style>

        <firebase-query path="/menu/items/{{itemKey}}/selections/{{selectionKey}}/subitems"
                        data="{{subitemlist}}">
        </firebase-query>

        <!--Subitems-->
        <template is="dom-repeat" items="{{subitemlist}}" as="subitem" sort="_sortItems" observe="order">
            <paper-checkbox-custom class="checkbox" id="{{subitem.$key}}">
                <div class="subitemName">{{subitem.name}}</div>
                <div class="subitemPrice">{{_currencyFilter(subitem.price)}}</div>
            </paper-checkbox-custom>
        </template>

        </template>

    <script>

    Polymer({

        is: 'selection-multi-subitem',

        properties: {

            itemKey: {
                type: String,
            },

            selectionKey: {
                type: String
            },

            min: {
                type: Number,
                observer: '_checkChanged'
            },

            max: {
                type: Number,
                observer: '_checkChanged'
            },

            selected: {
                type: Array,
                observer: '_setValid'
            },

            selectionValid: {
                type: Boolean,
            }

        },

        listeners: {
            'iron-change' : '_checkChanged',
        },

        observers: [
            '_checkChanged(subitemlist.splices)'
        ],

        _checkChanged: function () {
            var cboxes = Polymer.dom(this.root).querySelectorAll('.checkbox');
            //check how many boxes checked
            var selected = { id: this.selectionKey, subitems: [] };
            var chkCount = 0
            for (var i in cboxes) {
                if (cboxes[i].checked) {
                    chkCount++;
                    selected.subitems.push({ id: cboxes[i].id });                 
                }
            }
            this.selected = selected;            

            //If somehow the number of checked boxes exceeds max then uncheck all
            if (chkCount > this.max) {
                for (var i in cboxes) {
                    cboxes[i].checked = false
                    cboxes[i].disabled = false;
                    this.toggleClass('disabled', false, cboxes[i]);
                }
            } else {
                //disable unchecked boxes if max limit reached
                //else enable all boxes
                if (chkCount >= this.max) {
                    for (var i in cboxes) {
                        if (!cboxes[i].checked) {
                            cboxes[i].disabled = true;
                            this.toggleClass('disabled', true, cboxes[i]);
                        }
                    }
                } else {
                    for (var i in cboxes) {
                        cboxes[i].disabled = false;
                        this.toggleClass('disabled', false, cboxes[i]);
                    }
                }
            }
        },

        _setValid: function () {
            var subtiemLength = this.selected.subitems.length;
            if ((subtiemLength >= this.min) && (subtiemLength <= this.max)) {
                this.selectionValid = true;
            } else {
                this.selectionValid = false;
            }
            this.fire('selection-valid-update');
        },

        _sortItems: function (a, b) {
            if (a.order == b.order) {
                return 0;
            }
            return a.order < b.order ? -1 : 1;
        },

        _currencyFilter: function (price) {
            if (price == 0) {
                return '';
            } else if (price < 1) {
                return '+ ' + (price * 100) + 'p';
            } else {
                return '+ £' + price.toFixed(2);
            }
        },

    });

    </script>
</dom-module>



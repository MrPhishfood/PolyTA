<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../poly-mods/paper-radio-group-custom.html">
<link rel="import" href="../poly-mods/paper-radio-button-custom.html">

<dom-module id="selection-single-subitem">
    <template>
        <style>
            :host {
                display: block;
            }

            paper-radio-button-custom {
                align-items: center;
                display: flex;
                padding: 10px 25px 10px 5px;
                flex-direction: row;
            }

            .subitemName {
                font-size: 15px;
                flex-grow: 99;
                padding: 0px 0px 0px 10px;
            }

            .subitemPrice {
                font-size: 15px;
            }
        </style>

        <firebase-query path="/menu/items/{{itemKey}}/selections/{{selectionKey}}/subitems"
                        data="{{subitemlist}}">
        </firebase-query>

        <!--Subitems-->
        <paper-radio-group-custom id="radioGroup" attr-for-selected="id" allow-empty-selection="{{_optional(min)}}">
            <template is="dom-repeat" items="{{subitemlist}}" as="subitem" sort="_sortItems" observe="order" >

                <paper-radio-button-custom class="checkbox" id="{{subitem.$key}}">
                    <div class="subitemName">{{subitem.name}}</div>
                    <div class="subitemPrice">{{_currencyFilter(subitem.price)}}</div>
                </paper-radio-button-custom>

            </template>
        </paper-radio-group-custom>

    </template>

    <script>

    Polymer({

        is: 'selection-single-subitem',

        properties: {

            itemKey: {
                type: String,
            },

            selectionKey: {
                type: String,
            },

            min: {
                type: Number,
                observer: '_checkChanged',
            },

            selected: {
                type: Array,
                observer: '_setValid'
            },

            selectionValid: {
                type: Boolean,
            }

        },

        listeners: {
            'iron-change': '_checkChanged',
        },

        observers: [
            '_checkChanged(subitemlist.splices)'
        ],

        _checkChanged: function () {
            var cboxes = Polymer.dom(this.root).querySelectorAll('.checkbox');

            //check how many boxes checked
            var selected = { id: this.selectionKey, subitems: []};
            for (var i in cboxes) {
                if (cboxes[i].checked) {
                    selected.subitems.push({ id: cboxes[i].id });
                }
            }
            this.selected = selected;
        },

        _setValid: function () {
            if (this.selected.subitems.length >= this.min) {
                this.selectionValid = true;
            } else {
                this.selectionValid = false;
            }
            this.fire('selection-valid-update');
        },

        _currencyFilter: function (price) {
            if (price == 0) {
                return '';
            } else if (price < 1) {
                return '+ ' + (price * 100) + 'p';
            } else {
                return '+ £' + price.toFixed(2);
            }
        },

        _sortItems: function (a, b) {
            if (a.order == b.order) {
                return 0;
            }
            return a.order < b.order ? -1 : 1;
        },

        _optional: function (min) {
            if (min == 0) { return true } else { false }
        },
    });

    </script>
</dom-module>

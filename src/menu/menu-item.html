<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">

<link rel="import" href="item-selection.html">


<dom-module id="menu-item">
    <template>
        <style>
            :host {
                display: block;

                --paper-card: {
                    display: inline-block;
                    position: relative;
                    box-sizing: border-box;
                    border-radius: 5px;
                    width: 100%;
                    margin-bottom: 25px;
                };

                --paper-card-content: {
                    padding: 11px;
                };

                --paper-fab-mini: {
                    position: absolute;
                    bottom: -10px;
                    right: -10px;
                    @apply(--shadow-elevation-4dp);
                };
            }

            paper-fab[hidden] {
                display: none !important;
            }

            paper-fab.add-cart {
                --paper-fab-background: var(--paper-teal-500);
                --paper-fab-keyboard-focus-background: var(--paper-teal-500);
            }

            paper-fab.selection-collapser {
                --paper-fab-background: var(--paper-orange-500);
                --paper-fab-keyboard-focus-background: var(--paper-orange-500);
            }

            paper-fab.collapse-closed {
                position: absolute;
                bottom: -10px;
                right: -10px;
            }

            paper-fab.collapse-opened {
                position: absolute;
                bottom: 40px;
                right: -10px;
            }

            .item-header {
                display: flex;
                align-items: flex-start;
            }

            .itemName {
                font-size: 17px;
                flex: 99;
            }

            .itemPrice {
                font-size: 18px;
                vertical-align: middle;
                padding-left: 15px;
                white-space: nowrap;
            }

            .itemShortdesc {
                width: 90%;
                font-size: 13px;
                margin: 0px 20px 0px 0px;
            }
        </style>

        <paper-card>
            <div class="card-content">
                <div>
                    <paper-ripple></paper-ripple>
                    <div class="item-header">
                        <div class="itemName">{{item.name}}</div>
                        <div class="itemPrice">{{_currencyFilter(item.price)}}</div>
                    </div>
                    <p class="itemShortdesc">{{item.shortdesc}}</p>
                </div>
                <!--Selections-->
                <template is="dom-if" if="{{_hasSelections(item)}}">
                    <iron-collapse id="item-{{item.$key}}-collapse">
                        <item-selection id="item-{{item.$key}}-selection" item-key="{{item.$key}}"></item-selection>
                    </iron-collapse>
                </template>
                <div>
                    <!--add to cart button-->
                    <template is="dom-if" if="{{!_hasSelections(item)}}">
                        <paper-fab class="add-cart" val="{{item.$key}}" mini icon="icons:add"
                                   on-tap="addToCart"></paper-fab>
                    </template>
                    <template is="dom-if" if="{{_hasSelections(item)}}">
                        <paper-fab id="item-{{item.$key}}-add-cart" val="{{item.$key}}" class="add-cart"
                                   mini icon="icons:add" hidden on-tap="addToCart"></paper-fab>
                        <paper-fab id="item-{{item.$key}}-collapser" val="{{item.$key}}"
                                   class="selection-collapser collapse-closed"
                                   mini icon="icons:expand-more" on-tap="selectionToggle"></paper-fab>
                    </template>
                </div>
            </div>
        </paper-card>

    </template>

    <script>

    Polymer({

        is: 'menu-item',

        properties: {
            item: {
                type: Object,
            },
        },

        listeners: {
            'item-selection-valid-update' : '_toggleCartFab',
        },

        _toggleCartFab: function (valid) {
            var fab = Polymer.dom(this.root).querySelector('#item-' + this.item.$key + '-add-cart');

            if (valid.detail) {
                fab.disabled = false;
            } else {
                fab.disabled = true;
            }                  
        },

        _currencyFilter: function (price) {
            if (price == 0) {
                return 'free';
            } else if (price < 1) {
                return (price * 100) + 'p';
            } else {
                return '£' + price.toFixed(2);
            }
        },

        _hasSelections: function (item) {
            return item.selections != null;
        },

        _hasSlider: function (item) {
            console.log(item.slider);
            return item.slider != null;
        },

        addToCart: function (e) {
            if (this.item.selections != null) {
                var item = Polymer.dom(this.root).querySelector('#item-' + this.item.$key + '-selection');

                this.fire('cart-added', { item: e.model.item, selections: item.getItemSelections() });
            } else {
                this.fire('cart-added', { item: e.model.item });
            }
            
        },

        selectionToggle: function (e) {
            var x = Polymer.dom(this.root);
            var collapser = x.querySelector('#item-' + e.model.item.$key + '-collapse');
            var collapsebutton = x.querySelector('#item-' + e.model.item.$key + '-collapser');
            var cartbutton = x.querySelector('#item-' + e.model.item.$key + '-add-cart');
            collapser.toggle();
            collapsebutton.toggleClass('collapse-closed');
            collapsebutton.toggleClass('collapse-opened');
            cartbutton.toggleAttribute('hidden');
            if (collapser.opened == true) {
                collapsebutton.setAttribute('icon', 'icons:expand-less');
            } else {
                collapsebutton.setAttribute('icon', 'icons:expand-more');
            }
        },


    });

    </script>
</dom-module>

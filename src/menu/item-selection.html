<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">

<link rel="import" href="selection-multi-subitem.html">
<link rel="import" href="selection-single-subitem.html">

<dom-module id="item-selection">
    <template>
        <style>
            :host {
                display: block;
            }

            .selection-header {
                display: flex;
                align-items: flex-start;
            }

            .selection-footer {
                display: flex;
                justify-content: flex-start;
                align-items: center;
                background-color: var(--paper-grey-200);                          
                border-radius: 4px;
                margin-right: 25px;
            }

            .selection-name {
                font-size: 16px;
                    flex-grow: 99;
            }

            .choice-prompt {
                font-size: 13px;
                color: var(--paper-grey-900);
                padding: 2px 11px;
                flex-grow: 99;
            }

            iron-icon[hidden] {
                display: none;
            }

            .icon-prompt-valid {
                --iron-icon-fill-color: var(--paper-green-500);
            }

            .icon-prompt-invalid {
                --iron-icon-fill-color: var(--paper-red-500);
            }
        </style>

        <firebase-query 
                        path="/menu/items/{{itemKey}}/selections"
                        data="{{selectlist}}">
        </firebase-query>

        <template is="dom-repeat" items="{{selectlist}}" as="selection" sort="_sortItems">
            <!--Multi Select-->
            <template is="dom-if" if="{{!_singleSelect(selection.max)}}">
                <div class="selectionbox">
                    <hr />

                    <div class="selection-header">
                        <div class="selection-name">{{selection.name}}</div>                       
                    </div>

                    <div class="selection-footer">
                        <div class="choice-prompt">{{_choicePrompt(selection.min,selection.max)}}</div>
                        <iron-icon id="icon-valid-{{selection.$key}}" class="icon-prompt-valid" icon="icons:check"></iron-icon>
                        <iron-icon id="icon-invalid-{{selection.$key}}" class="icon-prompt-invalid" icon="icons:close"></iron-icon>
                    </div>
                                      
                    <selection-multi-subitem class="selection" item-key="{{itemKey}}"
                                             selection-key="{{selection.$key}}"
                                             min="{{selection.min}}" max="{{selection.max}}">
                    </selection-multi-subitem>
                                   
                </div>
            </template>
            <!--Single Select-->
            <template is="dom-if" if="{{_singleSelect(selection.max)}}">
                <div class="selectionbox">
                    <hr />

                    <div class="selection-header">
                        <div class="selection-name">{{selection.name}}</div>                      
                    </div> 
                      
                    <div class="selection-footer">
                        <div class="choice-prompt">{{_choicePrompt(selection.min,selection.max)}}</div>
                        <iron-icon id="icon-valid-{{selection.$key}}" class="icon-prompt-valid" icon="icons:check"></iron-icon>
                        <iron-icon id="icon-invalid-{{selection.$key}}" class="icon-prompt-invalid" icon="icons:close"></iron-icon>
                    </div>
                                   
                    <selection-single-subitem class="selection" item-key="{{itemKey}}"
                                              selection-key="{{selection.$key}}"
                                              min="{{selection.min}}">
                    </selection-single-subitem>
                     
                </div>
            </template>               
        </template>

    </template>
    <script>

    Polymer({

        is: 'item-selection',

        properties: {

            itemKey: {
                type: String,
            },

            selectionsValid: {
                type: Boolean,
                observer: '_validChanged'
            },

        },

        getItemSelections: function () {
            var selections = Polymer.dom(this.root).querySelectorAll('.selection');

            var s = [];
            for (var i in selections) {
                if (selections[i].selected.subitems.length > 0) {
                    s.push(selections[i].selected);
                }               
            }
            return s;
        },

        listeners: {
            'selection-valid-update': '_checkValidSelections',
        },

        _checkValidSelections: function () {
            var selections = Polymer.dom(this.root).querySelectorAll('.selection');

            var valid = true;
            for (var i in selections) {
                var iconValid = Polymer.dom(this.root).querySelector('#icon-valid-' + selections[i].selectionKey);
                var iconInvalid = Polymer.dom(this.root).querySelector('#icon-invalid-' + selections[i].selectionKey);
                if (selections[i].selectionValid == false) {
                    valid = false;
                    this.attributeFollows('hidden', iconValid, iconInvalid);
                } else {
                    this.attributeFollows('hidden', iconInvalid, iconValid);
                }
            }
            this.selectionsValid = valid;
            
        },

        _sortItems: function (a, b) {
            if (a.order == b.order) {
                return 0;
            }
            return a.order < b.order ? -1 : 1;
        },

        _singleSelect: function (max) {
            if (max <= 1) { return true; } else { return false; }
        },

        _choicePrompt: function (min, max) {
            var verb = 'choose';
            if (min == 0) {
                if (max == 1) {
                    return verb + ' ' + max + ' (optional)';
                } else {
                    return verb + ' up to ' + max + ' (optional)';
                }
            } else {
                if (min == max) {
                    return verb + ' any ' + max;
                } else {
                    return verb + ' between ' + min + ' and ' + max;
                }
            }
        },

        _validChanged: function () {
            this.fire('item-selection-valid-update',this.selectionsValid);
        },

    });

    </script>
</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">

<!--App Elements-->
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<!--Iron Elements-->
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icons/maps-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html" />

<!--Paper Elements-->
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">

<!--Other Elements-->
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">

<link rel="import" href="ta-cart-tab.html">
<link rel="import" href="ta-menu.html">
<link rel="import" href="ta-shopping-cart.html">
<link rel="import" href="ta-login.html">

<!--Custom Elements-->
<!--<link rel="import" href="custom-icons.html"/>-->

<dom-module id="ta-shop">
    <template>
        <style>
            :host {
                display: block;
                --app-primary-color: #4285f4;
                --app-secondary-color: black;

                --paper-drawer-panel-drawer-container: {
                    /*background: var(--paper-grey-100);*/
                }
            }

            paper-drawer-panel {
                max-width: 900px;
                left: 0;
                right: 0;
                margin: 0 auto;
                @apply(--shadow-elevation-16dp);
            }

            paper-toolbar {
                --paper-toolbar-height: 85px;
                --paper-toolbar-sm-height: 60px;
            }

            #mainPanel {

            }

            #main-toolbar {
                --paper-toolbar-background: var(--paper-red-500);

            }

            #drawer-toolbar {
                --paper-toolbar-background: var(--paper-indigo-500);
            }

            .toolbar-button {
                color: #ffffff;
            }

            paper-badge {
                --paper-badge-margin-left: -3px;
                --paper-badge-margin-bottom: -15px;
                --paper-badge-background: var(--paper-teal-500);
            }

            paper-tabs {
                width:100%;
            }

            .drawer-list {
                margin: 0 20px;
            }

            .drawer-list a {
                display: block;
                padding: 0 16px;
                line-height: 40px;
                text-decoration: none;
                color: var(--app-secondary-color);
            }

            .drawer-list a.iron-selected {
                color: black;
                font-weight: bold;
            }

            .drawer-list a.subroute {
                padding-left: 32px;
            }

            .menu-category-item {
                font-size: 20px;
            }
        </style>

        <app-location route="{{route}}"></app-location>

        <app-route
            route="{{route}}"
            pattern="/:page"
            data="{{routeData}}"
            tail="{{subroute}}"
            active="active">
        </app-route>

        <firebase-app
            auth-domain="truyasia.firebaseapp.com"
            database-url="https://truyasia.firebaseio.com"
            api-key="AIzaSyCgfF2gQeiE1fyOWlaBcAcSLcwocz23BNk"
            storageBucket="truyasia.appspot.com">
        </firebase-app>

        <firebase-query
            path="/menu/categories"
            order-by-child="order"
            data="{{categoryList}}">
        </firebase-query>

        <firebase-query
            path="/menu/items"
            data="{{itemList}}">
        </firebase-query>

        <firebase-document
            path="/menu/items"
            data="{{cartItemList}}">
        </firebase-document>

       <firebase-auth
            id="auth"
            user="{{user}}"
            on-error="handleError">
        </firebase-auth>

        <iron-media-query query="(min-width: 550px)" query-matches="{{queryMatches}}"></iron-media-query>

            <paper-drawer-panel id="mainPanel" responsive-width="549px" elevation="2">
                <paper-header-panel drawer id="leftDrawer" mode="waterfall">
                    <!--Tabs Toolbar-->
                    <paper-toolbar id="drawer-toolbar"  >
                        <paper-tabs selected="{{tabpage}}" attr-for-selected="name">
                            <paper-tab name="menutab"><iron-icon icon="icons:chrome-reader-mode"></iron-icon>Menu</paper-tab>
                            <paper-tab name="carttab"><iron-icon icon="icons:shopping-cart"></iron-icon>Cart</paper-tab>
                        </paper-tabs>
                    </paper-toolbar>
                    <!--Tab Pages-->
                    <iron-pages selected="[[tabpage]]" attr-for-selected="name">
                        <!--Menu Tab-->
                        <div name="menutab">
                            <template is="dom-repeat" items="{{categoryList}}" as="category">
                                <paper-item class="menu-category-item" on-tap="scrollToMenuSection">
                                    {{category.name}}
                                </paper-item>
                            </template>
                        </div>
                    </iron-pages>
                    <!--Insert Other Tabs-->
                </paper-header-panel>
                <!--Main Section-->
                <paper-scroll-header-panel main>
                    <!--Toolbar-->
                    <paper-toolbar id="main-toolbar">
                        <paper-icon-button icon="icons:menu" paper-drawer-toggle></paper-icon-button>
                        <span class="title">Truly Asia</span>
                        <paper-icon-button icon="icons:3d-rotation"class="toolbar-button" on-tap="_login"></paper-icon-button>
                        <a href="/login"><paper-icon-button icon="icons:account-box" class="toolbar-button"></paper-icon-button></a>
                        <a href="/"><paper-icon-button icon="icons:chrome-reader-mode" class="toolbar-button"></paper-icon-button></a>
                        <a href="/shopping-cart"><paper-icon-button id="headercart" icon="icons:shopping-cart" class="toolbar-button"></paper-icon-button></a>
                        <paper-badge for="headercart" label="{{cartBadge}}" hidden$="{{!cartBadge}}"></paper-badge>
                    </paper-toolbar>
                    <!--Pages-->
                    <iron-pages selected="[[page]]" attr-for-selected="name">
                        <ta-menu id="menulistpage" name="menu" category-list="{{categoryList}}" item-list="{{itemList}}"></ta-menu>
                        <ta-shopping-cart name="shopping-cart" cart="{{cart}}"></ta-shopping-cart>
                        <ta-login name="login"></ta-login>
                    </iron-pages>
                </paper-scroll-header-panel>
            </paper-drawer-panel>

            <paper-toast id="toast0" text=""></paper-toast>
    </template>
    <script>

        Polymer({

            is: 'ta-shop',

            properties: {

                routeData: {
                  type: Object,
                },

                subroute: {
                  type: Object,
                },

                user: {
                  type: Object,
                },

                page: {
                    type: String,
                    reflectToAttribute: true,
                    observer: '_pageChanged',
                },

                categoryList: {
                    type: Array,
                },

                itemList: {
                    type: Array,
                    notify: true,
                },

                cartItemList: {
                    type: Object,
                    observer: '_cartItemListChanged'
                },

                tabpage: {
                    type: String,
                    value: 'menutab',
                },

                cart: {
                    type: Object,
                    observer: '_updateCartCookie',
                },

                cartBadge: {
                    type: Number,
                    value: 0,
                },

                queryMatches: {
                  type: Boolean,
                  readOnly: true,
                }

            },

            listeners: {
                'cart-added': 'addToCart',
                'cart-plus' : 'plusFromCart',
                'cart-minus': 'minusFromCart',
                'cart-deleted': 'deleteFromCart',
            },

            observers: [
              '_routePageChanged(routeData.page)',
            ],

            _routePageChanged: function (page) {
                this.page = page || 'menu';
            },

            _pageChanged: function (page) {
                // load page import on demand.
                this.importHref(
                  this.resolveUrl('ta-' + page + '.html'), null, null, true);
            },

            openDrawer: function () {
                this.$.mainPanel.openDrawer();
            },

            tabToCart: function () {
                this.tabpage = 'carttab';
                this.$.mainPanel.openDrawer();
            },

            _login: function () {
                console.log(this.$.auth);
                this.$.auth.signInWithPopup('google').then(function (reponse) {
                    console.log(response);
                    console.log(this.user);
                }).catch(function (error) {
                    console.log(error);
                })
            },

            scrollToMenuSection: function (e) {
                this.$.menulistpage.scollToSection(e.model.category.$key);
                this.$.mainPanel.closeDrawer();
            },

            //Add item to cart
            addToCart: function (e) {
                console.log(e.detail);
                var itemObj = e.detail;
                //Call toast only from menu list
                function toasty(t, e) {
                  if (e.path[0].localName == 'menu-item') {
                    t.$.toast0.show({ text: '+ ' + itemObj.item.name, duration: 1300 });
                  }
                }
                var index = ItemIndex(this.cart.items, itemObj);
                //Single item changes add to qty
                if (itemObj.item.selections == null) {
                    if (index !== false) {

                        //Add to qunatity
                        this.set(['cart.items', index, 'qty'], this.cart.items[index].qty + 1);
                    } else {
                        //add new item
                        var newItem = { item: itemObj.item, qty: 1 };
                        this.push('cart.items', newItem);
                    }
                    toasty(this, e);
                //Selecton item changes add to qty if selections same
                } else {
                    if (index !== false) {
                        this.set(['cart.items', index, 'qty'], this.cart.items[index].qty + 1);
                    } else {
                        var newItem = { item: itemObj.item, qty: 1, selections: e.detail.selections };
                        this.push('cart.items', newItem);
                    }
                    toasty(this,e);
                }
                this._updateCartCookie();
            },

            plusFromCart: function (e) {
                this.set(['cart.items', e.detail.index, 'qty'], e.detail.item.qty + 1);
                this._updateCartCookie();
            },

            minusFromCart: function (e) {
                this.set(['cart.items', e.detail.index, 'qty'], e.detail.item.qty - 1);
                this._updateCartCookie();

                if (e.detail.item.qty == 0) {
                    this.deleteFromCart(e);
                }
            },

            deleteFromCart: function (e) {
                this.splice('cart.items', e.detail.index, 1);
                this._updateCartCookie();
            },

            //Syncs the 'cart' cookie with this.cart
            loadCartFromCookie: function (itemArray) {
                var cartdata = getCartCookieJSON();
                var newCart = { items: [] };

                for (x = 0; x < cartdata.items.length; x++) {

                    var found = itemArray.filter(
                        function (data) { return data.$key == cartdata.items[x].id }
                    );

                    if (found.length) {
                        var itemdata = { item: found[0], qty: cartdata.items[x].qty };
                        //add selection data if any
                        if (cartdata.items[x].selections != null) {
                            itemdata.selections = cartdata.items[x].selections;
                        }
                        newCart.items.push(itemdata);
                    }
                }
                this.cart = newCart;
            },

            //Updates 'cart' cookie and the badge to sync with this.Cart
            _updateCartCookie: function () {

                var list = { items: [] };
                var cartBadge = 0
                for (i = 0; i < this.cart.items.length; i++) {
                    //check for selections
                    if (this.cart.items[i].selections == null) {
                        //single items
                        list.items.push({
                            id: this.cart.items[i].item.$key,
                            qty: this.cart.items[i].qty
                        });
                    } else {
                        //selection items
                        list.items.push({
                            id: this.cart.items[i].item.$key,
                            qty: this.cart.items[i].qty,
                            selections: this.cart.items[i].selections

                        })
                    }
                    cartBadge += this.cart.items[i].qty;

                }
                this.cartBadge = cartBadge;
                setCartCookieJSON(list);
            },

            //Casts items nodes in to array and loads the cart from cookie
            _cartItemListChanged: function (fbObject) {
                if (Object.getOwnPropertyNames(fbObject).length !== 0) {
                    var key;
                    var itemArray = [];
                    for (key in fbObject) {
                        fbObject[key].$key = key
                        itemArray.push(fbObject[key]);
                    }
                    this.loadCartFromCookie(itemArray);
                }
            },

        });

        function ItemIndex(items, itemObj) {
            //loop through cart items

            if (itemObj.selections) {
                //selections
                for (x = 0; x < items.length; x++) {
                    if (items[x].item.$key == itemObj.item.$key) {
                        if (JSON.stringify(items[x].selections) === JSON.stringify(itemObj.selections)) {
                            return x;
                        }
                    }
                }
                return false;
            } else {
                //single items
                for (x = 0; x < items.length; x++) {
                    if (items[x].item.$key == itemObj.item.$key) { return x; }
                }
                return false
            }


        }

        //Sets 'cart' cookie to arg:data
        function setCartCookieJSON(data) {
            var now = new Date();
            //Expires in 12 hours
            now.setTime(now.getTime() + 12 * 3600 * 1000);
            document.cookie = 'cart=' + JSON.stringify(data) + '; expires=' + now.toUTCString() + '; path=/';
        }

        //Gets the JSON data from 'cart' Cookie or empty cart object
        function getCartCookieJSON() {
            var oldCartData = getCookie('cart');
            var newCart;
            if (!oldCartData) {
                newCart = { items: [] };
            } else {
                newCart = JSON.parse(oldCartData);
            }
            return newCart;
        }

        //Simple get values for cookie, arg:cookie key
        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0) == ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(name) == 0) {
                    return c.substring(name.length, c.length);
                }
            }
            return "";
        }
    </script>
</dom-module>

<link rel="import" href="../bower_components/polymer/polymer.html">
<!--App Elements-->
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<!--Iron Elements-->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<!--Paper Elements-->
<link rel="import" href="../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<!--Google Elements-->
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">
<!--Custom Elements-->
<link rel="import" href="ta-cart.html">
<link rel="import" href="ta-menu.html">
<link rel="import" href="ta-shopping-cart.html">
<link rel="import" href="ta-login.html">
<link rel="import" href="ta-checkout.html">
<link rel="import" href="ta-payment.html">
<!-- Custom Icons -->
<link rel="import" href="custom-icons.html" />

<dom-module id="ta-shop">
  <template>
    <style>
       :host {
        display: block;
        --app-primary-color: #4285f4;
        --app-secondary-color: black;
      }

      #main-toolbar {
        position: relative;
        --paper-toolbar-background: var(--paper-red-500);
        --paper-toolbar-content: {
          max-width: 1280px;
          margin-left: auto;
          margin-right: auto;
        }
      }

      #drawer-toolbar {
        --paper-toolbar-background: var(--paper-indigo-500);
      }

      .toolbar-link {
        text-decoration: none;
      }

      .toolbar-button {
        color: #ffffff;
        font-size: 1.15rem;
        min-width: 0;
        min-height: 40px;
        padding: 8px;
        margin-right: 0;
        margin-left: 0;
        text-transform: none;
      }

      .toolbar-button iron-icon {
        --iron-icon-width: 24px;
        --iron-icon-height: 24px;
      }

      #menuButton {
        color: #fff;
      }

      .toolbar-text {
        margin-left: 2px;
      }

      paper-badge {
        --paper-badge-margin-left: -3px;
        --paper-badge-margin-bottom: -15px;
        --paper-badge-background: var(--paper-green-500);
      }

      paper-badge[alt-hidden] {
        display: none;
      }

      .drawer-list {
        margin: 0 20px;
      }

      .drawer-list a {
        display: block;
        padding: 0 16px;
        line-height: 40px;
        text-decoration: none;
        color: var(--app-secondary-color);
      }

      .drawer-list a.iron-selected {
        color: black;
        font-weight: bold;
      }

      .drawer-list a.subroute {
        padding-left: 32px;
      }

      .menu-category-item {
        font-size: 20px;
        --paper-item-focused-before: {
          opacity: 0;
        }
        ;
      }

      #categoryButton {
        visibility: visible;
        opacity: 1;
      }

      #bigTitle {
        position: fixed;
        font-size: 64px;
        line-height: 1;
        bottom: 16px;
      }

      #categoryButton[hidden] {
        visibility: hidden;
        opacity: 0;
        width: 0;
        padding: 0;
      }

      @media all and (min-width: 720px) {
        #cartCountBadge {
          display: none;
        }
      }

      @media all and (max-width: 721px) {
        .toolbar-text {
          display: none;
        }
      }

      @media all and (max-width: 979px) {
        #wideMenuButton {
          display: none;
        }
      }

      @media all and (min-width: 980px) {
        #categoryButton,
        #menuButton {
          display: none;
        }
        ;
      }

      #pages[selected="menu"]+#main-toolbar #menuButton {
        display: none;
      }

      #pages:not([selected="menu"])+#main-toolbar #categoryButton {
        display: none;
      }
    </style>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}" tail="{{subroute}}" active="active"></app-route>

    <firebase-app auth-domain="truyasia.firebaseapp.com" database-url="https://truyasia.firebaseio.com" api-key="AIzaSyCgfF2gQeiE1fyOWlaBcAcSLcwocz23BNk" storage-bucket="truyasia.appspot.com"></firebase-app>
    <firebase-query path="/menu/categories" order-by-child="order" data="{{categoryList}}"></firebase-query>
    <firebase-auth id="auth" user="{{user}}" on-error="handleError"></firebase-auth>

    <iron-media-query query="(min-width: 980px)" query-matches="{{sidebarQuery}}"></iron-media-query>
    <iron-media-query query="(min-width: 721px)" query-matches="{{wideToolbarQuery}}"></iron-media-query>

    <ta-cart id="cart" uid="[[user.uid]]" count="{{cartCount}}" total="{{cartTotal}}"></ta-cart>

    <paper-drawer-panel id="mainPanel" responsive-width="979px" disable-edge-swipe="[[_edgeSwipeDisable(sidebarQuery,page)]]" force-narrow="[[sidebarQuery]]">
      <!-- Drawer -->
      <paper-header-panel drawer id="leftDrawer" mode="seamed">
        <paper-toolbar id="drawer-toolbar"></paper-toolbar>
        <div id="slide-panel">
          <template is="dom-repeat" items="[[categoryList]]" as="category">
            <paper-item class="menu-category-item" on-tap="scrollToMenuSection">
              [[category.name]]
            </paper-item>
          </template>
        </div>
      </paper-header-panel>
      <!--Main Section-->
      <paper-scroll-header-panel id="mainScrollPanel" main fixed="[[sidebarQuery]]" on-iron-resize="_panelResized">
        <!-- iron-pages -->
        <iron-pages id="pages" selected$="[[page]]" attr-for-selected="name">
          <ta-menu id="menulistpage" name="menu"></ta-menu>
          <ta-shopping-cart name="shopping-cart"></ta-shopping-cart>
          <ta-checkout name="checkout"></ta-checkout>
          <ta-payment name="payment"></ta-payment>
          <ta-login name="login"></ta-login>
        </iron-pages>
        <!--Toolbar-->
        <paper-toolbar id="main-toolbar" class="[[_calculateMedTallClass(sidebarQuery)]]">
          <!-- <span id="bigTitle" class="">Truly Asia</span> -->
          <a href="/" class="middle toolbar-link">
            <paper-icon-button id="menuButton" class="middle" icon="custom-icons:arrow-back"></paper-icon-button>
          </a>
          <paper-icon-button id="categoryButton" class="middle" icon="custom-icons:menu" paper-drawer-toggle></paper-icon-button>
          <span id="smallTitle" class="title middle">TRULY ASIA</span>
          <a href="/payment" class="middle">
            <paper-icon-button icon="custom-icons:account-box" class="toolbar-button"></paper-icon-button>
          </a>
          <a id="wideMenuButton" href="/" class="middle toolbar-link">
            <paper-button class="toolbar-button">
              <iron-icon icon="custom-icons:chrome-reader-mode"></iron-icon>
              <span class="toolbar-text">Menu</span>
            </paper-button>
          </a>
          <a href="/login" class="middle toolbar-link">
            <paper-button class="toolbar-button">
              <iron-icon icon="custom-icons:account-box"></iron-icon>
              <span class="toolbar-text">Account</span>
            </paper-button>
          </a>
          <a href="/shopping-cart" class="middle toolbar-link">
            <paper-button id="headercart" class="toolbar-button">
              <iron-icon id="cart-icon" icon="custom-icons:shopping-cart"></iron-icon>
              <span class="toolbar-text">Cart [[_currencyFilter(cartTotal)]]</span>
            </paper-button>
            <paper-badge id="cartCountBadge" for="headercart" label="[[cartCount]]" hidden$="[[!cartCount]]" alt-hidden$="[[sidebarQuery]]"></paper-badge>
          </a>
        </paper-toolbar>
      </paper-scroll-header-panel>
    </paper-drawer-panel>
    <paper-toast id="toast0" text=""></paper-toast>
  </template>
  <script>
    Polymer({
      is: 'ta-shop',
      properties: {

        routeData: {
          type: Object
        },

        subroute: {
          type: Object
        },

        user: {
          type: Object,
          observer: '_userchange'
        },

        page: {
          type: String,
          reflectToAttribute: true,
          observer: '_pageChanged'
        },

        categoryList: {
          type: Array
        },

        tabpage: {
          type: String,
          value: 'menutab'
        },

        cart: {
          type: Object,
          observer: '_updateCartCookie'
        },

        cartBadge: {
          type: Number,
          value: 0
        }

      },
      listeners: {
        'ta-menu-scrollcategory': 'scrollToMenuSection',
        'cart-plus': 'plusFromCart',
        'cart-minus': 'minusFromCart',
        'cart-deleted': 'deleteFromCart',
        'checkout-tapped': '_pageToCheckout',
        'sign-in': '_login',
        'logout': '_logout'
      },

      observers: ['_routePageChanged(routeData.page)'],
      _routePageChanged: function(page) {
        this.page = page || 'menu';
      },

      _pageChanged: function(page) {
        // load page import on demand.
        this.importHref(this.resolveUrl('ta-' + page + '.html'), null, null, true);
        if (this.page === 'menu') {
          this.$.menulistpage.debounceRecalculateHeight();
        }
      },

      _calculateMedTallClass: function(query) {
        return query ?
          'medium-tall' :
          '';
      },

      openDrawer: function() {
        this.$.mainPanel.openDrawer();
      },

      tabToCart: function() {
        this.tabpage = 'carttab';
        this.$.mainPanel.openDrawer();
      },

      _pageToCheckout: function() {
        this.page = 'checkout';
      },

      _login: function(e) {
        console.log(e.detail);
        this.$.auth.signInWithPopup(e.detail);
      },

      _logout: function() {
        this.$.auth.signOut();
      },

      _userchange: function(user) {
        //CREATE USER PROFILE IF NON EXISTS check if logged in
        if (this.user && !this.user.isAnonymous) {
          console.log('create profile', this.user);
          var profileEl = this.$.fbUserProfile;
          profileEl.ref.once('value').then(function(snapshot) {
            //if no profile exists
            if (!snapshot.val()) {
              //create profile data obj
              var userProfile = {
                email: user.email,
                provider: user.providerData[0].providerId
              };
              //create profile
              profileEl.ref.set(userProfile, function(error) {
                if (error) {
                  console.log('user creation failure:' + error);
                } else {
                  console.log('user creation success');
                }
              });
            }
          });
        }
      },

      _edgeSwipeDisable: function(sidebarQuery, page) {
        if (page != 'menu' || sidebarQuery) {
          return true;
        }
        return false;
      },

      scrollToMenuSection: function(e) {
        var yPos;
        if (e.model) {
          yPos = this.$.menulistpage.getCategoryYPos(e.model.category.$key);
        } else {
          yPos = this.$.menulistpage.getCategoryYPos(e.detail);
        }
        this.$.mainScrollPanel.scroll(yPos - 50, true);
        this.$.mainPanel.closeDrawer();
      },

      _panelResized: function(e) {
        // if (this.itemList) {
        if (this.page === 'menu') {
          this.$.menulistpage.debounceRecalculateHeight();
        }
      },

      _currencyFilter: function(price) {
        if (price === 0) {
          return '£0.00';
        } else if (price < 100) {
          return price + 'p';
        } else {
          return '£' + (price / 100).toFixed(2);
        }
      },

      ready: function() {
        //when the firebase-auth element tries to log in on startup
        var auth = this.$.auth.auth;
        //observer function triggered when the state of authentication changes on page init fired when auth element attempts to auto login
        auth.onAuthStateChanged(function(user) {
          //if user has no json token for login
          if (!user) {
            //create anon login
            auth.signInAnonymously().catch(function(error) {
              // Handle Errors here.
              var errorCode = error.code;
              var errorMessage = error.message;
              if (errorCode === 'auth/operation-not-allowed') {
                alert('You must enable Anonymous auth in the Firebase Console.');
              } else {
                console.error(error);
              }
            });
          }
        });
      }
    });
  </script>
</dom-module>
